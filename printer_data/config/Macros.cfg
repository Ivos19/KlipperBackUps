[homing_override]
gcode:
    {% if not 'Z' in params and not 'Y' in params and 'X' in params %}
    SENSORLESS_HOME_X
    {% elif not 'Z' in params and not 'X' in params and 'Y' in params %}
    SENSORLESS_HOME_Y
    {% elif not 'Z' in params and 'X' in params and 'Y' in params %}
    SENSORLESS_HOME_Y
    SENSORLESS_HOME_X
    {% elif 'Z' in params and not 'X' in params and not 'Y' in params %}
    Z_Home_WithEddy #G28 Z
    {% else %}
    G4 P1500
    SENSORLESS_HOME_Y
    SENSORLESS_HOME_X
    Z_Home_WithEddy #G28 Z
    {% endif %}
axes: xyz

[gcode_macro Z_Home_WithEddy]
description: Homing Z usando Eddy NG en modo TAP
gcode:
    {% if not printer.toolhead.homed_axes or
          ('x' not in printer.toolhead.homed_axes) or
          ('y' not in printer.toolhead.homed_axes) %}

        # Mensaje en consola (solo una vez)
        { action_respond_info("‚ùå No se puede hacer Home Z con Eddy NG. Se requiere conocer posicion X e Y del cabezal.") }

        # Cancela sin generar errores ni template exceptions
        M117 Cancelando homing Z...
        G4 P300
        RESPOND TYPE=error MSG="Homing Z cancelado"
        G4 P10
        # Fin del macro sin usar RETURN ni EXIT
    {% else %}
    
        # --- Obtener posicion actual ---
        {% set x = printer.toolhead.position.x %}
        {% set y = printer.toolhead.position.y %}
    
        # --- Calcular zona segura ---
        {% set safe_x = 30 %}
        {% set safe_y = (printer.configfile.settings['probe_eddy_ng btt_eddy'].y_offset | float * -1) + 30 %}
        # --- Calcular zona segura ---
        #{% set safe_x = 30 %}
        #{% set safe_y = 30 + (printer.configfile.settings['probe_eddy_ng btt_eddy'].y_offset | float) %}
    
        G90
    
        # --- Ajustar X ---
        {% if x < safe_x %}
            {% set new_x = safe_x %}
        {% else %}
            {% set new_x = x %}
        {% endif %}
    
        # --- Ajustar Y ---
        {% if y < safe_y %}
            {% set new_y = safe_y %}
        {% else %}
            {% set new_y = y %}
        {% endif %}
    
        # --- Mover si hace falta ---
        G1 X{new_x} Y{new_y} F6000
    
        # --- Secuencia oficial Eddy NG ---
        G28 Z
        G90
        G0 Z2 F1000
        G4 S1
        M400
        PROBE_EDDY_NG_PROBE_STATIC HOME_Z=1
        G0 Z5 F1000

        G4 P200
        { action_respond_info("üîé Eddy home done!") }
        #{ action_respond_info("‚úî Z homed con Eddy NG TAP") }

    {% endif %}

[gcode_macro TEST_SAFE_Y]
gcode:
    {% set safe_y = 30 + (printer.configfile.settings['probe_eddy_ng btt_eddy'].y_offset | float) %}
    { action_respond_info("safe_y = " ~ safe_y) }
    G0 Y{safe_y} F6000
  

[gcode_macro SENSORLESS_HOME_X]
gcode:
    {% set HOME_CUR = 0.700 %}
    {% set driver_config = printer.configfile.settings['tmc2209 stepper_x'] %}
    {% set RUN_CUR = driver_config.run_current %}
    # Set current for sensorless homing
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CUR}
    # Pause to ensure driver stall flag is clear
    G4 P2000
    # Home
    G28 X0
    # Move away
    G90
    G1 X5 F1200
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CUR}

[gcode_macro SENSORLESS_HOME_Y]
gcode:
    {% set HOME_CUR = 0.700 %}
    {% set driver_config = printer.configfile.settings['tmc2209 stepper_y'] %}
    {% set RUN_CUR = driver_config.run_current %}
    # Set current for sensorless homing
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CUR}
    # Pause to ensure driver stall flag is clear
    G4 P2000
    # Home
    G28 Y0
    # Move away
    G90
    G1 Y5 F2400 #F1200
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CUR}

[gcode_macro HOME_Z_ONLY]
gcode:
    G28 Z0                  ; Hacer homing del eje Z solamente
    G91                     ; Modo relativo
    G1 Z5 F600              ; Sub√≠ un poco para seguridad
    G90                     ; Volv√© a modo absoluto

[gcode_macro BLTOUCH_ProveCal]
gcode:
    PROBE_CALIBRATE

[gcode_macro BLTOUCH_Reset]
gcode:
    BLTOUCH_DEBUG COMMAND=reset

[gcode_macro BLTOUCH_Down]
gcode:
    BLTOUCH_DEBUG COMMAND=pin_down

[gcode_macro BLTOUCH_Up]
gcode:
    BLTOUCH_DEBUG COMMAND=pin_up

[gcode_macro CHECK_BLTOUCH]
description: Verifica el estado del BLTouch
gcode:
    BLTOUCH_DEBUG COMMAND=reset
    BLTOUCH_DEBUG COMMAND=touch_mode
    QUERY_PROBE

[gcode_macro MOVE_TO_CENTER]
gcode:
    G91                      ; Modo relativo
    G1 Z5 F600               ; Sub√≠ 5 mm para evitar golpear algo
    G90                      ; Volv√© a modo absoluto
    G1 X150 Y150 Z25 F3000   ; Movete a X150 Y150 Z25

[gcode_macro Pureba_Velocidad]
gcode:
    G1 X150 Y25 Z25
    G1 X150 Y150 F12000
    G1 X150 Y25

[gcode_macro GO_DERECHAS_ATRAS]
gcode:
    G90
    G1 Z10 F600
    G1 X10 Y55 F3000        ; BLTouch en (10,10)

[gcode_macro GO_IZQUIERDA_ATRAS]
gcode:
    G90
    G1 Z10 F600
    G1 X290 Y55 F3000       ; BLTouch en (290,10)

[gcode_macro GO_DERECHA_ADELANTE]
gcode:
    G90
    G1 Z10 F600
    G1 X10 Y290 F3000       ; BLTouch en (10,245)

[gcode_macro GO_IZQUIERDA_ADELANTE]
gcode:
    G90
    G1 Z10 F600
    G1 X290 Y290 F3000      ; BLTouch en (290,245)

[gcode_macro CLEAN_NOZZLE]
description: "Calienta a 140C y limpia la boquilla raspando suavemente la cama"
gcode:
    # Preparaci√≥n
    M117 Limpiando nozzle
    M104 S140                       ; Calienta nozzle a 140C (no espera)
    G90                             ; Coordenadas absolutas
    # Aseguro Z alto antes de mover
    G1 Z10 F3000
    # Posici√≥n segura para limpiar (puede ajustarse)
    G1 X10 Y10 F6000
    # Espero a que el nozzle llegue a 140C
    M109 S140

    # Secuencia de limpieza
    # Bajo a una altura segura sobre la cama
    G1 Z0.20 F300
    # Primera pasada larga (raspado suave)
    G1 X10 Y200  F6000 #X200 Y10 F2000
    # Subo un poco y vuelvo
    ;G1 Z0.30 F300
    G1 X10 Y10 F6000
    # Segunda pasada un poco m√°s baja
    #G1 Z0.25 F300
    #G1 X200 Y10 F2000
    # Limpieza en zig-zag suave
    G1 Z0.05 F300
    G1 X20  Y20 F6000
    G1 X10 Y30 F6000
    G1 X20  Y40 F6000
    G1 X10 Y50 F6000

    G1 X20  Y40 F6000
    G1 X10 Y30 F6000
    G1 X20  Y20 F6000
    G1 X10 Y10 F6000

    # Finalizaci√≥n
    G1 Z5 F3000                     ; Subo nozzle
    M117 Limpieza completada

[gcode_macro START_PRINT]
variable_bed_temp: 60
variable_extruder_temp: 185
gcode:

    #  Inicializaci√≥n
    GET_MAX_SPEED_SET_TMC_MODE
    #{ action_respond_info("üî•üü• Comenzar a calentar cama") }
    M140 S{bed_temp}            ; Empieza a calentar cama (sin esperar)
    G90                         ; Coordenadas absolutas
    #  Homing
    G28                         ; Home completo
    # Subo un poco para evitar golpear nada
    G1 Z10 F3000

    # Limpio el nozzle
    #{ action_respond_info("ü™• Limpio nozzle") }
    CLEAN_NOZZLE               ; Ejecuta el macro de limpieza
    
    # PROBE_EDDY_NG_TAP
    # Lo ponemos antes del mesh, cama caliente, nozzle fr√≠o.
    # Me muevo a un lugar seguro para hacer el TAP
    # Eleg√≠ X150 Y150 porque la cama es 300x300 y es seguro en el centro
    G1 X150 Y150 F6000

    #  Calentamiento cama
    M117 Calentando Cama
    #{ action_respond_info("‚åõüü• Esperamos Cama en temperatura") }
    M190 S{bed_temp}            ; Espera cama al objetivo
    
    # Hacemos Home Z por si esto es requerido. Por el offset, si la cama no esta bien horizontal puede cambiar... CREO
    M117 Home Z
    G4 P200
    #{ action_respond_info("üè† Home Z") }
    G28 Z #Z_Home_WithEddy

    # Ejecuta el TAP NG del Eddy
    M117 Calibrando Eddy
    G4 P200
    #{ action_respond_info("„Ä∞Ô∏è Calibrando Eddy") }
    PROBE_EDDY_NG_TAP

    # Hacemos Home Z por si esto es requerido. Por el offset, si la cama no esta bien horizontal puede cambiar... CREO
    # M117 Home Z
    # G4 P200
    #{ action_respond_info("üè† Home Z") }
    # G28 Z #Z_Home_WithEddy
    
    #  Bed mesh
    M117 Nivelando Cama
    #{ action_respond_info("üìê Nivelamos cama") }
    BED_MESH_CALIBRATE METHOD=rapid_scan
    #  Calentamiento del extrusor
    
    M117 Calentando Extrusor
    #{ action_respond_info("‚åõüîª Esperamos Nozzle en temperatura") }
    M109 S{extruder_temp}       ; Espera extrusor caliente
    
    #  Purga en el borde
    M117 Purgando
    #{ action_respond_info("‚è¨ Purgamos") }
    G92 E0
    G1 Z2.0 F3000
    G1 X2.1 Y20 Z0.28 F5000.0
    G1 X2.1 Y200.0 Z0.28 F1500.0 E15
    G1 X2.4 Y200.0 Z0.28 F5000.0
    G1 X2.4 Y20 Z0.28 F1500.0 E30
    G92 E0
    G1 Z2.0 F3000

    #{ action_respond_info("‚úÖ‚ñ∂Ô∏è Todo listo, iniciamos!") }
    M117 Irma trabajando!!

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
gcode:
  TURN_OFF_HEATERS
  M106 S0
  G91
  G1 E-8 F1800       ; retract corto para evitar goteo
  G1 Z10 F600        ; sube 10mm (tu cama baja)
  # Resetting Z Offset
  SET_GCODE_OFFSET Z_ADJUST=0.0
  # Restauramos valores z offset Eddy
  PROBE_EDDY_NG_SET_TAP_OFFSET VALUE=0
  # Olvidamos el BedMesh
  BED_MESH_CLEAR
  G90
  CLEAR_PAUSE
  SDCARD_RESET_FILE
  M84                ; apaga los motores

# --------------------------------------------------------------------

# ---------------------------- End Print -----------------------------
[gcode_macro END_PRINT]
#variable_machine_depth: 235
gcode:
    # Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    M106 S0
    # Relative positionning
    G91
    # Retract and raise Z
    G1 Z0.2 E-8 F2400
    # Wipe out
    G1 X5 Y5 F3000
    # Raise Z more
    G1 Z10
    # Absolute positionning
    G90
    # Present print
    G1 X25 Y25
    # Disable steppers
    M84
    # Resetting Z Offset
    SET_GCODE_OFFSET Z_ADJUST=0.0
    # Restauramos valores z offset Eddy
    PROBE_EDDY_NG_SET_TAP_OFFSET VALUE=0
    # Olvidamos el BedMesh
    BED_MESH_CLEAR
    # Print message on LCD
    M117 Listorti querido

# --------------------------------------------------------------------

# ---------------------------- Pruebas -----------------------------

[gcode_macro TEST_BED_LEVELING]
gcode:
    G28

    # Eleg√≠ X150 Y150 porque la cama es 300x300 y es seguro en el centro
    G1 X150 Y150 F8000
    # Hacemos Home Z por si esto es requerido. Por el offset, si la cama no esta bien horizontal puede cambiar... CREO
    M117 Home Z
    G4 P200
    #{ action_respond_info("üè† Home Z") }
    G28 Z #Z_Home_WithEddy

    # Ejecuta el TAP NG del Eddy
    M117 Calibrando Eddy
    G4 P200
    #{ action_respond_info("„Ä∞Ô∏è Calibrando Eddy") }
    PROBE_EDDY_NG_TAP

    # Hacemos Home Z por si esto es requerido. Por el offset, si la cama no esta bien horizontal puede cambiar... CREO
    M117 Home Z
    G4 P200
    #{ action_respond_info("üè† Home Z") }
    G28 Z #Z_Home_WithEddy
    
    #  Bed mesh
    M117 Nivelando Cama
    #{ action_respond_info("üìê Nivelamos cama") }
    BED_MESH_CALIBRATE METHOD=rapid_scan
    #  Calentamiento del extrusor





