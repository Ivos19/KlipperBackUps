[respond]

[gcode_shell_command test_echo_cmd]
command: echo Hola desde un shell command
timeout: 5.0
verbose: True

[gcode_shell_command test_py_script]
command: /home/biqu/printer_data/config/py/test_py_script.py
timeout: 5
verbose: True

[gcode_shell_command multiParamScript]
command: /usr/bin/python3 /home/biqu/printer_data/config/py/multiParamScript_script.py
timeout: 30.0
verbose: True

[gcode_macro TEST_PY_SCRIPT]
gcode:
    RUN_SHELL_COMMAND CMD=test_py_script

[gcode_macro TEST_ECO_CMD]
gcode:
    RUN_SHELL_COMMAND CMD=test_echo_cmd

[gcode_macro TEST_MULTI_PARAMETER_PY]
gcode:
    {% set param1_value = 100 %}
    {% set param2_value = "hello" %}
    {% set param3_value = printer.extruder.target|int %}

    RUN_SHELL_COMMAND CMD=multiParamScript PARAMS="{param1_value} {param2_value} {param3_value}"


[gcode_shell_command eddying]
command: /usr/bin/python3 /home/biqu/printer_data/config/py/EddyBedCheck.py
timeout: 5.0
verbose: True

[gcode_macro EDDY_TEST]
description: Test de estabilidad de cama usando Eddy NG
variable_z_test: 1.0
variable_iterations: 1
gcode:
    #g28
    # --- CAMBIO 1: Offset correcto del sensor
    {% set sensor_offset_x = 0 %}
    {% set sensor_offset_y = -48 %}   # sensor 48mm adelante → offset NEGATIVO

    # --- CAMBIO 2: Aumentar margen (30 era insuficiente)
    {% set margin = 50 %}             # mínimo ≥ 48

    # --- CAMBIO 3: Reemplazar tuplas por diccionarios (Klipper no soporta tuplas)
    {% set points = [
        {"x": margin, "y": margin},
        {"x": 300-margin, "y": margin},
        {"x": 300-margin, "y": 300-margin},
        {"x": margin, "y": 300-margin},
        {"x": 150, "y": 150}
    ] %}

    M117 Iniciando test Eddy
    M118 {points}

    {% for cycle in range(iterations|int) %}
        M118 Ciclo {cycle + 1} de {iterations}

        {% for p in points %}
            # --- CAMBIO 4: Acceso correcto a p.x y p.y
            {% set sx = p.x %}
            {% set sy = p.y %}

            # --- CAMBIO 5: Cálculo correcto evitando Y negativas
            {% set nx = sx - sensor_offset_x %}
            {% set ny = sy - sensor_offset_y %}   # sy - (-48) = sy + 48

            M118 Coordinates nozzle=[{nx}, {ny}] sensor=[{sx}, {sy}]

            G90
            G1 X{nx} Y{ny} F12000
            G1 Z{z_test} F2000

            #RUN_SHELL_COMMAND CMD=eddying ARGS="{nx} {ny} {sx} {sy} {z_test} {cycle}"
            PEPS
            RUN_SHELL_COMMAND CMD=eddying PARAMS="{nx} {ny} {sx} {sy} {z_test} {cycle}"

        {% endfor %}

        G1 Z20 F2000
    {% endfor %}

    M117 Test Eddy finalizado

