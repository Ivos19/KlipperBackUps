[respond]

[gcode_shell_command pythonEddy]
command: python3 /home/biqu/printer_data/config/py/eddyc_test.py
timeout: 10.0
verbose: False

[gcode_shell_command testecho]
command: echo hola
timeout: 5.0
verbose: True

[gcode_shell_command test_py]
command: /home/biqu/printer_data/config/py/test.py
timeout: 5
verbose: True

[gcode_macro TEST_PY]
gcode:
    RUN_SHELL_COMMAND CMD=test_py

[gcode_macro EDDY_TEST]
description: "Test repetibilidad Eddy NG en 5 puntos"
variable_iterations: 3
variable_safe_z: 5
variable_test_height: 1
variable_margin: 30
variable_probe_offset_y: 48

gcode:
    {% set it = iterations|int %}
    {% set th = test_height|float %}
    {% set mz = safe_z|float %}
    {% set m = margin|float %}
    {% set oy = probe_offset_y|float %}

    # Puntos base (coordenadas donde debe estar el SENSOR)
    {% set points = [
        (m, m),
        (300 - m, m),
        (m, 300 - m),
        (300 - m, 300 - m),
        (150, 150)
    ] %}

    {action_respond_info("Iniciando test Eddy (" ~ it ~ " iteraciones)")}

    # Crear la instancia del script
    RUN_SHELL_COMMAND CMD="python3 ~/printer_data/config/py/eddyc_test.py init"

    G90
    G28

    {% for n in range(it) %}
        {action_respond_info("Iteracion " ~ (n+1))}

        # Por cada punto
        {% for p in points %}
            {% set sx, sy = p %}

            # Calcular posición del NOZZLE compensando offset del probe
            {% set nx = sx %}
            {% set ny = sy + oy %}

            # Mover a altura segura
            G1 Z{mz} F3000
            # Mover el nozzle a la posición calculada
            G1 X{nx} Y{ny} F8000
            # Bajar a altura de test
            G1 Z{th}

            # Sacar lectura
            QUERY_PROBE

            # Acceder al valor del probe (Greenfield para Eddy)
            {% set ed = printer.probe.last_query|default(0) %}

            # Logging
            # RUN_SHELL_COMMAND CMD="python3 ~/printer_data/config/py/eddyc_test.py log {{nx}} {{ny}} {{sx}} {{sy}} {{th}} {{ed}}"
            RUN_SHELL_COMMAND CMD="python3 ~/printer_data/config/py/eddyc_test.py log {nx} {ny} {sx} {sy} {th} {ed}"

        {% endfor %}

        # Mover Z para siguiente iteración
        G1 Z{mz}
        G4 P500
    {% endfor %}

    {action_respond_info("Test completado. Archivo guardado en logs/")}